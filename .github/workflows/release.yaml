name: Release

on:
  release:
    types: [created]

jobs:
  # Build x86_64 wheels
  build-wheels-x86_64:
    name: Build wheels (x86_64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64-unknown-linux-gnu
          manylinux: 2_28
          args: --release --features python -i python3.10 -i python3.11 -i python3.12 -i python3.13 -i python3.14
          before-script-linux: |
            (apt-get update && apt-get install -y libxkbcommon-dev) || yum install -y libxkbcommon-devel || dnf install -y libxkbcommon-devel

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-x86_64
          path: target/wheels/*.whl

  # Build aarch64 wheels
  build-wheels-aarch64:
    name: Build wheels (aarch64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: aarch64-unknown-linux-gnu
          manylinux: 2_28
          args: --release --features python -i python3.10 -i python3.11 -i python3.12 -i python3.13 -i python3.14
          docker-options: -e PKG_CONFIG_ALLOW_CROSS=1 -e PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig
          before-script-linux: |
            # Install aarch64 libxkbcommon for cross-compilation
            dpkg --add-architecture arm64
            . /etc/os-release
            # Pin existing sources to amd64 only (arm64 is on ports.ubuntu.com)
            sed -i 's/^deb http/deb [arch=amd64] http/' /etc/apt/sources.list
            echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $VERSION_CODENAME main universe" > /etc/apt/sources.list.d/arm64.list
            echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ $VERSION_CODENAME-updates main universe" >> /etc/apt/sources.list.d/arm64.list
            apt-get update
            apt-get install -y pkg-config libxkbcommon-dev:arm64

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-aarch64
          path: target/wheels/*.whl

  test-pypi:
    name: Test PyPI release
    runs-on: ubuntu-latest
    needs: [build-wheels-x86_64, build-wheels-aarch64]
    permissions:
      id-token: write
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist/
          merge-multiple: true

      - name: Publish to Test PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          packages-dir: dist/
          verbose: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Get version from tag
        run: |
          echo "EITYPE_TAG=${{ github.event.release.tag_name }}" >> $GITHUB_ENV

      - name: Sleep for Test PyPI indexing
        run: sleep 120

      - name: Test install from Test PyPI
        run: |
          pip install \
          --index-url https://test.pypi.org/simple/ \
          --extra-index-url https://pypi.org/simple \
          eitype==${{ env.EITYPE_TAG }}

  release-pypi:
    name: Publish eitype on PyPI
    runs-on: ubuntu-latest
    needs: test-pypi
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist/
          merge-multiple: true

      - name: Publish package
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          verbose: true

  # Publish Rust crate to crates.io
  release-crates:
    name: Publish eitype on crates.io
    runs-on: ubuntu-latest
    needs: release-pypi
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libxkbcommon-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
